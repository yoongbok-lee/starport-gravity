{"version":3,"sources":["../src/SPClient.ts"],"names":["SPClient","apiAddr","rpcAddr","wsAddr","poll","connectivityTest","bind","timer","setInterval","socket","ReconnectingWebSocket","onopen","onOpenWS","onmessage","onMessageWS","onerror","onErrorWS","onclose","onCloseWS","signer","SigningStargateClient","connectWithSigner","signingClient","emit","registry","axios","get","response","console","error","SpClientError","send","JSON","stringify","jsonrpc","method","id","params","msg","result","parse","data","type","url","query","key","value","encodeURIComponent","Array","isArray","join","rawQuery","keys","Object","filter","map","toQueryString","addQueryParam","queryString","body","path","addQueryParams","headers","Accept","EventEmitter"],"mappings":"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","sourcesContent":["import { EventEmitter } from 'events';\r\nimport ReconnectingWebSocket from 'reconnecting-websocket';\r\nimport axios, { AxiosPromise, AxiosResponse } from 'axios';\r\nimport { SigningStargateClient } from '@cosmjs/stargate';\r\nimport { OfflineDirectSigner, Registry } from '@cosmjs/proto-signing';\r\nimport SpClientError from './errors/SpClientError';\r\nexport interface IClientConfig {\r\n  apiAddr: string;\r\n  rpcAddr?: string;\r\n  wsAddr?: string;\r\n}\r\nexport type QueryParamsType = Record<string | number, any>;\r\nexport interface IFullRequestParams {\r\n  body?: unknown;\r\n  path: string;\r\n  query?: QueryParamsType;\r\n  method: 'GET' | 'POST' | 'PUT';\r\n}\r\n\r\nexport default class SPClient extends EventEmitter {\r\n  private apiAddr: string;\r\n  private rpcAddr: string;\r\n  private wsAddr: string;\r\n\r\n  private socket: ReconnectingWebSocket;\r\n\r\n  public signingClient;\r\n  private signer: OfflineDirectSigner;\r\n  private timer: ReturnType<typeof setInterval>;\r\n\r\n  constructor({ apiAddr, rpcAddr, wsAddr }: IClientConfig) {\r\n    super();\r\n    this.apiAddr = apiAddr;\r\n    this.rpcAddr = rpcAddr;\r\n    this.wsAddr = wsAddr;\r\n    const poll: any = this.connectivityTest.bind(this);\r\n    this.timer = setInterval(poll, 5000);\r\n    this.connectivityTest();\r\n    if (this.wsAddr) {\r\n      this.socket = new ReconnectingWebSocket(this.wsAddr);\r\n\r\n      this.socket.onopen = this.onOpenWS.bind(this);\r\n      this.socket.onmessage = this.onMessageWS.bind(this);\r\n      this.socket.onerror = this.onErrorWS.bind(this);\r\n      this.socket.onclose = this.onCloseWS.bind(this);\r\n    }\r\n  }\r\n  public async useSigner(signer: OfflineDirectSigner): Promise<void> {\r\n    this.signingClient = await SigningStargateClient.connectWithSigner(\r\n      this.rpcAddr,\r\n      signer,\r\n    );\r\n    this.signer = signer;\r\n  }\r\n  public switchAPI(apiAddr: string): void {\r\n    this.apiAddr = apiAddr;\r\n  }\r\n  public switchWS(wsAddr: string): void {\r\n    this.emit('ws-status', false);\r\n    this.wsAddr = wsAddr;\r\n    this.socket = new ReconnectingWebSocket(this.wsAddr);\r\n  }\r\n  public async switchRPC(rpcAddr: string): Promise<void> {\r\n    this.rpcAddr = rpcAddr;\r\n    if (this.signingClient) {\r\n      const registry: Registry = { ...this.signingClient.registry };\r\n      this.signingClient = await SigningStargateClient.connectWithSigner(\r\n        this.rpcAddr,\r\n        this.signer,\r\n        { registry },\r\n      );\r\n    }\r\n  }\r\n  private async connectivityTest(): Promise<void> {\r\n    if (this.apiAddr) {\r\n      try {\r\n        await axios.get(this.apiAddr + '/node_info');\r\n        this.emit('api-status', true);\r\n      } catch (error) {\r\n        if (!error.response) {\r\n          this.emit('api-status', false);\r\n          console.error(\r\n            new SpClientError('Client-js:API', 'API Node unavailable'),\r\n          );\r\n        } else {\r\n          this.emit('api-status', true);\r\n        }\r\n      }\r\n    }\r\n    if (this.rpcAddr) {\r\n      try {\r\n        await axios.get(this.rpcAddr);\r\n        this.emit('rpc-status', true);\r\n      } catch (error) {\r\n        if (!error.response) {\r\n          console.error(\r\n            new SpClientError('Client-js:API', 'RPC Node unavailable'),\r\n          );\r\n          this.emit('rpc-status', false);\r\n        } else {\r\n          this.emit('api-status', true);\r\n        }\r\n      }\r\n    }\r\n  }\r\n  private onErrorWS(): void {\r\n    console.error(\r\n      new SpClientError('Client-js:WS', 'Could not connect to websocket.'),\r\n    );\r\n  }\r\n  private onCloseWS(): void {\r\n    this.emit('ws-status', false);\r\n  }\r\n  private onOpenWS(): void {\r\n    this.emit('ws-status', true);\r\n    this.socket.send(\r\n      JSON.stringify({\r\n        jsonrpc: '2.0',\r\n        method: 'subscribe',\r\n        id: '1',\r\n        params: [\"tm.event = 'NewBlock'\"],\r\n      }),\r\n    );\r\n  }\r\n  private onMessageWS(msg: any): void {\r\n    const result: any = JSON.parse(msg.data).result;\r\n    if (result.data && result.data.type === 'tendermint/event/NewBlock') {\r\n      this.emit('newblock', JSON.parse(msg.data).result);\r\n    }\r\n  }\r\n  public async query(url: string, params = ''): Promise<any> {\r\n    try {\r\n      const response: any = await axios.get(this.apiAddr + url + params);\r\n      return response.data;\r\n    } catch (e) {\r\n      console.error(\r\n        new SpClientError('Client-js:API', 'Could not access API: ' + url),\r\n      );\r\n    }\r\n  }\r\n\r\n  private addQueryParam(query: QueryParamsType, key: string): string {\r\n    const value: any = query[key];\r\n\r\n    return (\r\n      encodeURIComponent(key) +\r\n      '=' +\r\n      encodeURIComponent(\r\n        Array.isArray(value)\r\n          ? value.join(',')\r\n          : typeof value === 'number'\r\n          ? value\r\n          : `${value}`,\r\n      )\r\n    );\r\n  }\r\n  protected toQueryString(rawQuery?: QueryParamsType): string {\r\n    const query: QueryParamsType = rawQuery || {};\r\n    const keys: string[] = Object.keys(query).filter(\r\n      (key) => 'undefined' !== typeof query[key],\r\n    );\r\n    return keys\r\n      .map((key) =>\r\n        typeof query[key] === 'object' && !Array.isArray(query[key])\r\n          ? this.toQueryString(query[key] as QueryParamsType)\r\n          : this.addQueryParam(query, key),\r\n      )\r\n      .join('&');\r\n  }\r\n  protected addQueryParams(rawQuery?: QueryParamsType): string {\r\n    const queryString: string = this.toQueryString(rawQuery);\r\n    return queryString ? `?${queryString}` : '';\r\n  }\r\n  public async request<T = any>({\r\n    body,\r\n    path,\r\n    query,\r\n    method,\r\n  }: IFullRequestParams): Promise<AxiosResponse<T>> {\r\n    const url: string = this.apiAddr + path + this.addQueryParams(query);\r\n    try {\r\n      const response: AxiosPromise<any> = axios({\r\n        url,\r\n        method,\r\n        data: body,\r\n        headers: {\r\n          Accept: 'application/json',\r\n          'Content-Type': 'application/json;charset=UTF-8',\r\n        },\r\n      });\r\n      const data: AxiosResponse<any> = await response;\r\n      return data;\r\n    } catch (e) {\r\n      console.error(\r\n        new SpClientError('Client-js:API', 'Could not access API: ' + url),\r\n      );\r\n    }\r\n  }\r\n}\r\n"],"file":"SPClient.js"}